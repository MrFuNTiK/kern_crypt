/**
 * @file transform.с
 * @author Kirill Voevodin.
 * @brief Преобразования XLPS-шифратора.
 * @version 0.1
 * @date 2025-11-30
 * 
 * @copyright Copyright (c) 2025
 * 
 */

#include <linux/slab.h>

#include "transform.h"

const uint8_t PI_FORWARD[256] = {
	252, 238, 221, 17,  207, 110, 49,  22,	251, 196, 250, 218, 35,	 197,
	4,   77,  233, 119, 240, 219, 147, 46,	153, 186, 23,  54,  241, 187,
	20,  205, 95,  193, 249, 24,  101, 90,	226, 92,  239, 33,  129, 28,
	60,  66,  139, 1,   142, 79,  5,   132, 2,   174, 227, 106, 143, 160,
	6,   11,  237, 152, 127, 212, 211, 31,	235, 52,  44,  81,  234, 200,
	72,  171, 242, 42,  104, 162, 253, 58,	206, 204, 181, 112, 14,	 86,
	8,   12,  118, 18,  191, 114, 19,  71,	156, 183, 93,  135, 21,	 161,
	150, 41,  16,  123, 154, 199, 243, 145, 120, 111, 157, 158, 178, 177,
	50,  117, 25,  61,  255, 53,  138, 126, 109, 84,  198, 128, 195, 189,
	13,  87,  223, 245, 36,	 169, 62,  168, 67,  201, 215, 121, 214, 246,
	124, 34,  185, 3,   224, 15,  236, 222, 122, 148, 176, 188, 220, 232,
	40,  80,  78,  51,  10,	 74,  167, 151, 96,  115, 30,  0,   98,	 68,
	26,  184, 56,  130, 100, 159, 38,  65,	173, 69,  70,  146, 39,	 94,
	85,  47,  140, 163, 165, 125, 105, 213, 149, 59,  7,   88,  179, 64,
	134, 172, 29,  247, 48,	 55,  107, 228, 136, 217, 231, 137, 225, 27,
	131, 73,  76,  63,  248, 254, 141, 83,	170, 144, 202, 216, 133, 97,
	32,  113, 103, 164, 45,	 43,  9,   91,	203, 155, 37,  208, 190, 229,
	108, 82,  89,  166, 116, 210, 230, 244, 180, 192, 209, 102, 175, 194,
	57,  75,  99,  182};

const uint8_t PI_REVERSE[256] = {
	165, 45,  50,  143, 14,	 48,  56,  192, 84,  230, 158, 57,  85,	 126,
	82,  145, 100, 3,   87,	 90,  28,  96,	7,   24,  33,  114, 168, 209,
	41,  198, 164, 63,  224, 39,  141, 12,	130, 234, 174, 180, 154, 99,
	73,  229, 66,  228, 21,	 183, 200, 6,	112, 157, 65,  117, 25,	 201,
	170, 252, 77,  191, 42,	 115, 132, 213, 95,  175, 43,  134, 167, 177,
	178, 91,  70,  211, 159, 253, 212, 15,	156, 47,  155, 67,  239, 217,
	121, 182, 83,  127, 193, 240, 35,  231, 37,  94,  181, 30,  162, 223,
	166, 254, 172, 34,  249, 226, 74,  188, 53,  202, 238, 120, 5,	 107,
	81,  225, 89,  163, 242, 113, 86,  17,	106, 137, 148, 101, 140, 187,
	119, 60,  123, 40,  171, 210, 49,  222, 196, 95,  204, 207, 118, 44,
	184, 216, 46,  54,  219, 105, 179, 20,	149, 190, 98,  161, 59,	 22,
	102, 233, 92,  108, 109, 173, 55,  97,	75,  185, 227, 186, 241, 160,
	133, 131, 218, 71,  197, 176, 51,  250, 150, 111, 110, 194, 246, 80,
	255, 93,  169, 142, 23,	 27,  151, 125, 236, 88,  247, 31,  251, 124,
	9,   13,  122, 103, 69,	 135, 220, 232, 79,  29,  78,  4,   35,	 248,
	243, 62,  61,  189, 138, 136, 221, 205, 11,  19,  152, 2,   147, 128,
	144, 208, 36,  52,  203, 237, 244, 206, 153, 16,  68,  64,  146, 58,
	1,   38,  18,  26,  72,	 104, 245, 129, 139, 199, 214, 32,  10,	 8,
	0,   76,  215, 116};

const uint8_t TAU_FORWARD[BLOCK_SIZE] = {
	0, 8,  16, 24, 32, 40, 48, 56, 1, 9,  17, 25, 33, 41, 49, 57,
	2, 10, 18, 26, 34, 42, 50, 58, 3, 11, 19, 27, 35, 43, 51, 59,
	4, 12, 20, 28, 36, 44, 52, 60, 5, 13, 21, 29, 37, 45, 53, 61,
	6, 14, 22, 30, 38, 46, 54, 62, 7, 15, 23, 31, 39, 47, 55, 63};

const uint8_t TAU_REVERSE[BLOCK_SIZE] = {
	0, 8,  16, 24, 32, 40, 48, 56, 1, 9,  17, 25, 33, 41, 49, 57,
	2, 10, 18, 26, 34, 42, 50, 58, 3, 11, 19, 27, 35, 43, 51, 59,
	4, 12, 20, 28, 36, 44, 52, 60, 5, 13, 21, 29, 37, 45, 53, 61,
	6, 14, 22, 30, 38, 46, 54, 62, 7, 15, 23, 31, 39, 47, 55, 63};

const uint64_t A_FORWARD[BLOCK_SIZE] = {
	0x8e20faa72ba0b470, 0x47107ddd9b505a38, 0xad08b0e0c3282d1c,
	0xd8045870ef14980e, 0x6c022c38f90a4c07, 0x3601161cf205268d,
	0x1b8e0b0e798c13c8, 0x83478b07b2468764, 0xa011d380818e8f40,
	0x5086e740ce47c920, 0x2843fd2067adea10, 0x14aff010bdd87508,
	0x0ad97808d06cb404, 0x05e23c0468365a02, 0x8c711e02341b2d01,
	0x46b60f011a83988e, 0x90dab52a387ae76f, 0x486dd4151c3dfdb9,
	0x24b86a840e90f0d2, 0x125c354207487869, 0x092e94218d243cba,
	0x8a174a9ec8121e5d, 0x4585254f64090fa0, 0xaccc9ca9328a8950,
	0x9d4df05d5f661451, 0xc0a878a0a1330aa6, 0x60543c50de970553,
	0x302a1e286fc58ca7, 0x18150f14b9ec46dd, 0x0c84890ad27623e0,
	0x0642ca05693b9f70, 0x0321658cba93c138, 0x86275df09ce8aaa8,
	0x439da0784e745554, 0xafc0503c273aa42a, 0xd960281e9d1d5215,
	0xe230140fc0802984, 0x71180a8960409a42, 0xb60c05ca30204d21,
	0x5b068c651810a89e, 0x456c34887a3805b9, 0xac361a443d1c8cd2,
	0x561b0d22900e4669, 0x2b838811480723ba, 0x9bcf4486248d9f5d,
	0xc3e9224312c8c1a0, 0xeffa11af0964ee50, 0xf97d86d98a327728,
	0xe4fa2054a80b329c, 0x727d102a548b194e, 0x39b008152acb8227,
	0x9258048415eb419d, 0x492c024284fbaec0, 0xaa16012142f35760,
	0x550b8e9e21f7a530, 0xa48b474f9ef5dc18, 0x70a6a56e2440598e,
	0x3853dc371220a247, 0x1ca76e95091051ad, 0x0edd37c48a08a6d8,
	0x07e095624504536c, 0x8d70c431ac02a736, 0xc83862965601dd1b,
	0x641c314b2b8ee083};

const uint64_t A_REVERSE[BLOCK_SIZE] = {
	0x62AB88CD0972E917, 0x31DB44E88A39FA85, 0x96E3227445927DCC,
	0x4BFF113AAC49B066, 0xABF1861D56AA5833, 0xDBF643802B552C97,
	0xE37BAF409BA416C5, 0xFFB3D920C3520BEC, 0x37AC80EC39310F5C,
	0x955640769296892E, 0xC42B203B494BCA17, 0x629B1093AAAB6585,
	0x31C308C755DBBCCC, 0x96EF04EDA4E35E66, 0x4BF902F852FF2F33,
	0xABF2017C29F19997, 0x7BA7F6D2966A717C, 0xB3DD7B694B35B63E,
	0xD7E0B3BAAB945B1F, 0xE570D75DDB4AA381, 0xFC38E5A0E325DFCE,
	0x7E1CFC50FF9CE167, 0x3F0E7E28F14EFEBD, 0x91073F14F6277FD0,
	0x8F75C66271C4C510, 0xC9B46331B662EC08, 0xEA5ABF965B317604,
	0x752DD14BA3963B02, 0xB498E6ABDF4B9301, 0x5A4C73DBE1ABC78E,
	0x2D26B7E3FEDBED47, 0x9813D5FF7FE3F8AD, 0xA27784688A48D4EF,
	0x51B5423445246AF9, 0xA6D4211AAC1235F2, 0x536A9E0D56099479,
	0xA7354F882B8A4AB2, 0xDD94A9449B452559, 0xE04ADA22C3AC9CA2,
	0x70256D11EF564E51, 0x38D6992F43439CAA, 0x1C6BC299AFAF4E55,
	0x0EBB61C2D9D927A4, 0x07D3BE61E2E29D52, 0x8DE75FBE7171C029,
	0xC8FDA15FB6B6609A, 0x64F0DEA15B5B304D, 0x32786FDEA3A318A8,
	0x7388FC7DF56416B6, 0xB7447EB0F4320B5B, 0xD5223F587A198BA3,
	0xE411912C3D82CBDF, 0x7286C6169041EBE1, 0x3943630B48AEFBFE,
	0x92AFBF8B2457F37F, 0x49D9D1CB12A5F7B1, 0x321902AD3C69A5E9,
	0x198201D81EBADCFA, 0x82418E6C0F5D6E7D, 0x41AE473689A037B0,
	0xAE57AD1BCA509558, 0x57A5D8836528C42C, 0xA5DC6CCFBC146216,
	0xDC6E36E95E0A310B,
};

void X_transform512(uint8_t *block, const uint8_t *key)
{
	uint8_t buf[BLOCK_SIZE];
	uint8_t i;
	WARN_ON(block == NULL);
	WARN_ON(key == NULL);
	for (i = 0; i < BLOCK_SIZE; ++i) {
		buf[i] = block[i] ^ key[i];
	}
	memcpy(block, buf, BLOCK_SIZE);
}

void L_transform512(uint8_t *block, const uint64_t *A_matrix)
{
	uint64_t word = 0;
	uint8_t buf[BLOCK_SIZE];
	uint8_t i;
	WARN_ON(block == NULL);
	WARN_ON(A_matrix == NULL);
	for (i = 0; i < BLOCK_SIZE / 8; ++i) {
		uint64_t res = 0;
		uint8_t j;
		memcpy(&word, block + (i * BLOCK_SIZE / 8), 8);
		for (j = 0; j < BLOCK_SIZE; ++j) {
			if (word & (1ull << j)) {
				res ^= A_matrix[63 - j];
			}
		}
		memcpy(buf + (i * BLOCK_SIZE / 8), &res, 8);
	}
	memcpy(block, buf, BLOCK_SIZE);
}

void P_transform512(uint8_t *block, const uint8_t *tau)
{
	uint8_t buf[BLOCK_SIZE];
	uint8_t i;
	WARN_ON(block == NULL);
	WARN_ON(tau == NULL);
	for (i = 0; i < BLOCK_SIZE; ++i) {
		buf[TAU_FORWARD[i]] = block[i];
	}
	memcpy(block, buf, BLOCK_SIZE);
}

void S_transform512(uint8_t *block, const uint8_t *pi)
{
	uint8_t buf[BLOCK_SIZE];
	uint8_t i;
	WARN_ON(block == NULL);
	WARN_ON(pi == NULL);
	for (i = 0; i < BLOCK_SIZE; ++i) {
		buf[i] = pi[block[i]];
	}
	memcpy(block, buf, BLOCK_SIZE);
}
